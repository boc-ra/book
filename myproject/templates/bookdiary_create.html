{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}
{% block content %}
    <h1>記録の作成</h1>
    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            <label>{{ form.date.label }}</label>
            {{ form.date | add_class:'form-control col-2' }}
        </div>
        <div class="form-group">
            <label>{{ form.title.label }}</label>
            {{ form.title | add_class:'form-control col-2' }}
            <ul id="book-suggestions" style="list-style: none; padding-left: 0;"></ul>
        </div>
        <div class="form-group">
            <label>{{ form.writer.label }}</label>
            {{ form.writer | add_class:'form-control col-2' }}
        </div>
        <div class="form-group">
            <label>{{ form.text.label }}</label>
            {{ form.text | add_class:'form-control col-2' }}
        </div>
        <button type="submit" class="form-control col-1">記録</button>
    </form>
    <script>

        document.getElementById('book-title').addEventListener('input', function() {
            let query = this.value;
            if (query.length < 3) {
                document.getElementById('book-suggestions').innerHTML = '';
                return;
            }

            fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${query}`)
                .then(response => response.json())
                .then(data => {
                    let suggestions = data.items || [];
                    let suggestionList = document.getElementById('book-suggestions');
                    suggestionList.innerHTML = '';

                    suggestions.forEach(function(item) {
                        let listItem = document.createElement('li');
                        listItem.textContent = item.volumeInfo.title;
                        listItem.addEventListener('click', function() {
                            document.getElementById('book-title').value = item.volumeInfo.title;
                            document.getElementById('book-writer').value = item.volumeInfo.authors ? item.volumeInfo.authors.join(', ') : 'Unknown';
                            document.getElementById('book-suggestions').innerHTML = '';
                        });
                        suggestionList.appendChild(listItem);
                    });
                })
                .catch(error => console.error('Error fetching books:', error));
        });
    </script>
{% endblock %}
